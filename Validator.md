# Validator

The Validator is a command line tool and collection of Java classes that can be used
to support validation.

Validator is implemented in the `com.ainq.izgateway.extract.Validator` class and has
a command line interface described in the [Validator](Validator.md) description page.

## Usage
```
    $ java -classpath extract-validator.jar com.ainq.izgateway.extract.Validator [options]? [files] ...
```

### Options
-7[folder]
: Write HL7 Message Format to files in the specified output folder. The file
will be named the same as the input file, but will have the .hl7 extension.
To write the HL7 message to standard output, use -7-
To write the HL7 message to standard error output, use -7--

-c[folder]
: Write Tab Delimited Format from files.  Uses .txt as the extension
and otherwise works like -7 above.

-b[folder]
: Write both HL7 Message and Tab Delimited format output files.

-i
: Write all inputs to output, ignoring errors. Use with -b, -c, or -7 options above.
-I
: Write only the inputs that are valid to the output (stop ignoring errors).

-n
: Turn off output writing.

-v1
: Use Version 1 CVRS Validation Tables
-v1
: Use Version 2 CVRS Validation Tables

-e
: Exit, ignoring further command line arguments

-k
: Start a comment on the command line

-K
: End a comment

-s[error code,...]|ALL
: Suppress validation for the specified errors (e.g., -sDATA001,DATA002)
: Use -sALL to supress all messages

-S[error code,...]|ALL
: Stop suppressing validation for the specified errors (e.g., -sDATA001,DATA002)

file ... One ore more HL7 V2 VXU Message or Tab Delimited Files

The type of file will automatically detected from its content.

Tab Delimited Files must conform to the CDC CVRS Tab Delimited Format

HL7 VXU Message Files can contain a single HL7 V2 Message, multiple messages, and may
be formatted as an HL7 Batch using FHS, FTS, BHS and BTS Segments.

Each HL7 V2 Segment must be terminated by a newline or carriage-return or
carriage-return/newline pair of characters.

Messages in the file are delimited by HL7 Segments (MHS, FHS, BHS, BTS and BHS segments).
File and Batch Header and Trailer segments are ignored.

## Output
Output generated by this tool contains a detailed report followed by a summary report for each
file that is validated.

### Detailed Report
The detailed report is printed on the standard output stream.
```
File                             Vax_Event_Id     Line   Level  Field                    Error  Description
src\test\resour***102_01_COA.txt 1149755          1      ERROR  vtrcks_prov_pin          DATA005 vtrcks_prov_pin (1379) does not match the regular expression ^\d{6}?
src\test\resour***102_01_COA.txt 1149755          1      ERROR  admin_address_county     DATA007 admin_address_county (90035) is not in value set COUNTY[45001, 22001 ... 48507, 46137]
src\test\resour***102_01_COA.txt 1149755          1      ERROR  admin_address_county     BUSR002 admin_address_county (90035) does not match admin_address_state (CO) for Vaccine Administrator
src\test\resour***102_01_COA.txt 1149755          1      WARN   recip_address_zip        BUSR009 If recip_address_zip (80134) is present, recip_address_county () should be present for Recipient
	.
	.
	.
src\test\resour***102_01_COA.txt R9819            101    ERROR  recip_address_state      HL7_001 Message does not round trip at recip_address_state, '  ' != ''
src\test\resour***102_01_COA.txt R9820            102    ERROR  recip_address_state      DATA007 recip_address_state (  ) is not in value set STATE[AL, AK ... WI, WY]
src\test\resour***102_01_COA.txt R9820            102    ERROR  recip_race_1             REQD002 recip_race_1 is required for Refusal events
src\test\resour***102_01_COA.txt R9820            102    ERROR  recip_ethnicity          REQD002 recip_ethnicity is required for Refusal events
src\test\resour***102_01_COA.txt R9820            102    ERROR  admin_name               REQD002 admin_name is required for Refusal events
src\test\resour***102_01_COA.txt R9820            102    ERROR  admin_type               REQD002 admin_type is required for Refusal events
src\test\resour***102_01_COA.txt R9820            102    ERROR  admin_address_state      DATA007 admin_address_state (  ) is not in value set STATE[AL, AK ... WI, WY]
src\test\resour***102_01_COA.txt R9820            102    ERROR  recip_address_state      HL7_001 Message does not round trip at recip_address_state, '  ' != ''
src\test\resources\iis_example_files\20201102_01_COA.txt has 491 errors in 100 of 102 records.
```

The first line of the detail report are column headings describing the content.
* File - The name of the file being tested, with *** replacing middle characters for long file names
* Vax_Event_Id - The Value of the Vax_Event_Id associated with the record (may also be elided with ***)
* Line - The line number where the record was found (not counting the header row)
* Level - ERROR, WARN, or INFO to indicate the error severity. ERRORs must be fixed. WARN and INFO are advisory.
* Field - The field in error.  One of the CVRS Field names or ??? if a field name is unknown.
* Error - A 7 character error code identifying the type of error (See [Error Codes](#error-codes) below).
* Description - The complete text of the reported error message.

The last line of the detail report indicates the total number of errors found,
the total number of records with errors, and the total number of records read.

### Summary Report
The Summary report lists the error codes, counts of errors found for that code, and a general description
of the problem reported.

```
Code    Count   Description
BUSR001    27   recip_address_county in recip_address_state FIPS
BUSR002    43   admin_address_county in admin_address_state FIPS
BUSR003     3   recip_address_zip in recip_address_state STATE
BUSR009    65   recip_address_zip implies recip_address_county
DATA005   100   Does not match expected format
DATA007    75   Does not contain values from the expected value set
HL7_001    15   Message does not round trip (possibly due to input errors).
REQD001   157   A required field is missing for Vaccination
REQD002     6   A required field is missing for Refusal
```

### Error Codes
DATA Error codes denote conditions where a field failed to meet data type validation criteria.

REQD Error codes indicate that required data was not provided for an event (e.g., Vaccination, Refusal, Missed Appointment)

DNTS Error codes indicate that data was provided that was marked as do not send for an event.

BUSR Error codes indicate that one or more cross-field business rules failed validation.

HL7_ Error codes indicate that an error was detected converting to HL7 Format at the specified field.

Other error codes indicate an abnormal condition (an uncaught exception) and given the exception name for the code.

## Exit Codes
If all records validated successfully, the program will return an exit code of 0.
If one or more records had a validation error or warning, the progream will return an exit code of 1.
If an exception occurs that causes program termination, an exit code of < 1 will be returned to indicate
an execution error.

## Logging
These tools use HL7 HAPI V2 for Conversion to HL7 V2 Messages.  Those tools rely upon SLF4J for logging.
While using these tools from the command line, you may see the following reported in the standard error stream:
```
SLF4J: Failed to load class "org.slf4j.impl.StaticLoggerBinder".
SLF4J: Defaulting to no-operation (NOP) logger implementation
SLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details.
```

This is completely harmless.  We have not selected a logger binding so that these tools may be used with
other services that will provide such a binding, without forcing users of this software to reconfigure
these tools for their environment.